#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define bool int
#define false 0
#define true !false
#define CLOSE_PATCHER \
	if (!silent) { \
		puts("Press Enter to close the patcher."); \
		getchar(); \
	} \
	exit(1);
#define puts if (!silent) puts
#define printf if (!silent) printf
#define wait() if (!silent) while (getchar() != '\n');

typedef struct Patch_t {
	int pos;
	int orig;
	int new;
} Patch;

Patch upx_80[];
Patch joypatch_80[];
Patch joypatch_81_65[];
Patch joypatch_81_141[];
Patch dplaypatch_80[];
Patch dplaypatch_81_65[];
Patch dplaypatch_81_141[];
Patch schedpatch_80[];
Patch schedpatch_80upx[];
Patch schedpatch_81_65[];
Patch schedpatch_81_141[];

bool silent = false;

static int can_patch(FILE *f, Patch patches[]) {
	// returns 2 if already patched, 1 if unpatched, 0 if it's not the right file
	bool unpatched = true;
	bool patched = true;
	int c;
	for (Patch *p = patches; p->pos != -1; p++) {
		fseek(f, p->pos, SEEK_SET);
		c = fgetc(f);
		if (c != p->orig) {
			unpatched = false;
		}
		if (c != p->new) {
			patched = false;
		}
	}
	if (patched)
		return 2;
	if (unpatched)
		return 1;
	return 0;
}

static void strcatfn(char *s, const char *fn) {
#ifdef _WIN32
	// windows files can't have quotes so no sanitation necessary
	strcat(s, "\"");
	strcat(s, fn);
	strcat(s, "\"");
#else
	// unix files can have quotes so gotta sanitize
	for (int i = 0; i < strlen(fn); i++) {
		if (fn[i] != '"') {
			*s++ = fn[i];
		} else {
			*s++ = '\\';
			*s++ = '"';
		}
	}
	*s++ = '"';
	*s++ = 0;
#endif
}

static bool prompt(const char *text) {
	if (silent) return true;
	int c = 0;
	while (c != 'y' && c != 'n' && c != 'Y' && c != 'N') {
		printf(text);
		c = getchar();
		while (getchar() != '\n');
	}
	return (c == 'y' || c == 'Y');
}

// return true if a backup can be made
static bool rename_for_backup(const char *fn, const char *bak_fn) {
	puts("Making backup...");
	bool can_backup = true;
	// rename the original
	if (rename(fn, bak_fn)) {
		if (errno == EEXIST) {
			errno = 0;
			printf("There is already a file in location %s\n", bak_fn);
			if (prompt("Overwrite it? [y/n] ")) {
				if (remove(bak_fn)) {
					printf("Could not remove existing file (errno %i).\n", errno);
					if (prompt("Continue without making a backup? [y/n] ")) {
						can_backup = false;
					} else {
						CLOSE_PATCHER;
					}
				} else {
					if (rename(fn, bak_fn)) {
						printf("The existing file was deleted, but the backup could still not be made (errno %i).\n", errno);
						puts("I hope there wasn't anything important in there...");
						if (prompt("Continue without making a backup? [y/n] ")) {
							can_backup = false;
						} else {
							CLOSE_PATCHER;
						}
					}
				}
			} else {
				can_backup = false;
			}
		} else {
			printf("Failed to add .bak to the filename (errno %i).\n", errno);
			if (prompt("Continue without making a backup? [y/n] ")) {
				can_backup = false;
			} else {
				CLOSE_PATCHER;
			}
		}
	}
	return can_backup;
}

// de-upx if necessary, return true if unpacked
static bool upx(FILE **fp, const char *fn, const char *argv0) {
	FILE *f = *fp;
	// identify UPX headers
	fseek(f, 0x170, SEEK_SET);
	const char head1[] = {0x55, 0x50, 0x58, 0x30, 0, 0, 0, 0};
	for (int i = 0; i < 8; i++) {
		if (fgetc(f) != head1[i]) return false;
	}
	fseek(f, 0x198, SEEK_SET);
	const char head2[] = {0x55, 0x50, 0x58, 0x31, 0, 0, 0, 0};
	for (int i = 0; i < 8; i++) {
		if (fgetc(f) != head2[i]) return false;
	}
	// make backup filename
	char *bak_fn = malloc(strlen(fn) + 5);
	strcpy(bak_fn, fn);
	strcat(bak_fn, ".bak");
	// ask for confirmation
	printf("Will make a backup to %s\n", bak_fn);
	puts("Looks like your game was packed with UPX. We need to unpack it first.");
	puts("Please download the latest release of UPX from https://github.com/upx/upx/releases/tag/v3.96");
	puts("and put upx.exe in the same directory as gm8x_fix.exe, then press Enter to unpack.");
	wait();
	// rename original
	fclose(f);
	bool can_backup = rename_for_backup(fn, bak_fn);
	// get upx path
	char *cmd_buf = malloc(strlen(bak_fn) * 4 + strlen(argv0));
	int path_len = strlen(argv0);
	while (path_len > 0 && argv0[path_len-1] != '/'
#ifdef _WIN32
		&& argv0[path_len-1] != '\\'
#endif
	) {
		path_len--;
	}
	cmd_buf[path_len] = 0;
	if (path_len > 0) {
		strncpy(cmd_buf, argv0, path_len);
	}
	if (can_backup) {
		strcat(cmd_buf, "upx -d -o ");
		strcatfn(cmd_buf, fn);
		strcat(cmd_buf, " ");
		strcatfn(cmd_buf, bak_fn);
	} else {
		strcat(cmd_buf, "upx -d ");
		strcatfn(cmd_buf, fn);
	}
	int res = system(cmd_buf);
	if (res != 0) {
		printf("UPX unpack failed (error code %i).", res);
		if (can_backup && rename(bak_fn, fn) != 0) {
			printf("Could not restore the original file (errno %i).\n", errno);
			puts("Your game will have had .bak added to its filename, and no ");
			puts("patches have been applied.");
		} else {
			puts("The backup has been restored and the game is unchanged.");
		}
		free(bak_fn);
		free(cmd_buf);
		CLOSE_PATCHER;
	}
	free(bak_fn);
	free(cmd_buf);
	// reopen
	*fp = f = fopen(fn, "rb");
	return true;
}

static void patch_exe(FILE *f, Patch patches[]) {
	for (Patch *p = patches; p->pos != -1; p++) {
		fseek(f, p->pos, SEEK_SET);
		fputc(p->new, f);
	}
}

int main(int argc, const char *argv[]) {
	// check arguments
	const char *fn = NULL;
	bool valid_args = true;
	if (argc == 2) {
		fn = argv[1];
	} else if (argc == 3) {
		if (strcmp(argv[1], "-s") == 0) {
			silent = true;
			fn = argv[2];
		} else {
			valid_args = false;
		}
	} else {
		valid_args = false;
	}
	// funny title
	puts("Welcome to gm8x_fix v0.4.2!");
	puts("Source code is at https://github.com/skyfloogle/gm8x_fix under MIT license.");
	puts("---------------------------------------------------------------------------");
	// compain about arguments if necessary
	if (!valid_args) {
		puts("Error: Invalid arguments.");
		puts("Please drag your Game Maker game onto the patcher's executable file.");
		puts("Or if you're a commandline nerd, run with this:");
		puts(" gm8x_fix [-s] FILE");
		puts("Add -s to remove commandline output.");
		CLOSE_PATCHER;
	}
	printf("Inspecting file: %s\n\n", argv[1]);
	FILE *f = fopen(fn, "rb");
	if (f == NULL) {
		printf("Could not open file (errno %i).\n", errno);
		CLOSE_PATCHER;
	}
	if (fgetc(f) != 'M' || fgetc(f) != 'Z') {
		fclose(f);
		puts("This is not an executable file.");
		CLOSE_PATCHER;
	}
	// de-upx if necessary
	bool unpacked_upx = upx(&f, fn, argv[0]);
	// identify patches
	fseek(f, 0x116, SEEK_SET);
	int mempatch = !(!(fgetc(f) & 0x0020))+1; // IMAGE_FILE_LARGE_ADDRESS_AWARE flag
	int upx80 = can_patch(f, upx_80);
	int joy80 = can_patch(f, joypatch_80);
	int joy81_65 = can_patch(f, joypatch_81_65);
	int joy81_141 = can_patch(f, joypatch_81_141);
	int dplay80 = can_patch(f, dplaypatch_80);
	int dplay81_65 = can_patch(f, dplaypatch_81_65);
	int dplay81_141 = can_patch(f, dplaypatch_81_141);
	int sched80 = can_patch(f, schedpatch_80);
	int sched80upx = can_patch(f, schedpatch_80upx);
	int sched81_65 = can_patch(f, schedpatch_81_65);
	int sched81_141 = can_patch(f, schedpatch_81_141);
	bool any_patch_applied = upx80 == 2 || joy80 == 2 || joy81_65 == 2 || joy81_141 == 2 || sched80 == 2 || sched80upx == 2 || sched81_65 == 2 || sched81_141 == 2;
	bool can_apply_any = upx80 == 1 || joy80 == 1 || joy81_65 == 1 || joy81_141 == 1 || sched80 == 1 || sched80upx == 1 || sched81_65 == 1 || sched81_141 == 1;
	// list patches
	if (!can_apply_any && !any_patch_applied) {
		puts("This game cannot be patched. It may not be a GameMaker 8.0 or 8.1 game.");
		fclose(f);
		CLOSE_PATCHER;
	}
	if (unpacked_upx && can_apply_any && upx80 == 0) {
		puts("Unpacked with UPX, but header offset wasn't recognised. I haven't seen this before, please file an issue on the GitHub.");
		puts("You can continue applying patches if you want by pressing enter.");
		wait();
	}
	if (any_patch_applied) {
		puts("Patches already applied:");
		if (upx80 == 2) puts("* UPX unpacked header adjustment");
		if (mempatch == 2) puts("* Memory patch");
		if (joy80 == 2) puts("* GM8.0 joystick patch");
		if (joy81_65 == 2) puts("* GM8.1.65 joystick patch");
		if (joy81_141 == 2) puts("* GM8.1.141 joystick patch");
		if (dplay80 == 2) puts("* GM8.0 DirectPlay patch");
		if (dplay81_65 == 2) puts("* GM8.1.65 DirectPlay patch");
		if (dplay81_141 == 2) puts("* GM8.1.141 DirectPlay patch");
		if (sched80 == 2) puts("* GM8.0 scheduler patch");
		if (sched80upx == 2) puts("* GM8.0 (UPX unpacked) scheduler patch");
		if (sched81_65 == 2) puts("* GM8.1.65 scheduler patch");
		if (sched81_141 == 2) puts("* GM8.1.141 scheduler patch");
	}
	if (can_apply_any) {
		puts("Patches that can be applied:");
		if (upx80 == 1) puts("* UPX unpacked header adjustment (required, I won't ask for confirmation)");
		if (mempatch == 1) puts("* Memory patch");
		if (joy80 == 1) puts("* GM8.0 joystick patch");
		if (joy81_65 == 1) puts("* GM8.1.65 joystick patch");
		if (joy81_141 == 1) puts("* GM8.1.141 joystick patch");
		if (dplay80 == 1) puts("* GM8.0 DirectPlay patch");
		if (dplay81_65 == 1) puts("* GM8.1.65 DirectPlay patch");
		if (dplay81_141 == 1) puts("* GM8.1.141 DirectPlay patch");
		if (sched80 == 1) puts("* GM8.0 scheduler patch (requires joystick patch)");
		if (sched80upx == 1) puts("* GM8.0 (UPX unpacked) scheduler patch (requires joystick patch)");
		if (sched81_65 == 1) puts("* GM8.1.65 scheduler patch (requires joystick patch)");
		if (sched81_141 == 1) puts("* GM8.1.141 scheduler patch (requires joystick patch)");
	} else {
		puts("No new patches can be applied.");
		fclose(f);
		CLOSE_PATCHER;
	}
	// if we unpacked upx it's already backed up
	if (!unpacked_upx) {
		// make backup filename
		char *bak_fn = malloc(strlen(fn) + 5);
		strcpy(bak_fn, fn);
		strcat(bak_fn, ".bak");
		// ask for confirmation
		printf("Will make a backup to %s\n", bak_fn);
		printf("Press Enter to make a backup and choose patches to apply. ");
		wait();
		fclose(f); // i waited until here to close it so you can't mess with the file before confirming
		bool can_backup = rename_for_backup(fn, bak_fn);
		if (can_backup) {
			// copy it to the original location
			char *copy_cmd = malloc(strlen(bak_fn) * 4);
#ifdef _WIN32
			strcpy(copy_cmd, "copy ");
#else
			strcpy(copy_cmd, "cp ");
#endif
			strcatfn(copy_cmd, bak_fn);
			strcat(copy_cmd, " ");
			strcatfn(copy_cmd, fn);
			int res = system(copy_cmd);
			if (res != 0) {
				printf("File copy failed (error code %i).\n", res);
				if (rename(bak_fn, fn) != 0) {
					printf("Could not restore the original file (errno %i).\n", errno);
					puts("Your game will have had .bak added to its filename, and no ");
					puts("patches have been applied.");
				} else {
					puts("The backup has been restored and the game is unchanged.");
				}
				free(bak_fn);
				free(copy_cmd);
				CLOSE_PATCHER;
			}
			free(bak_fn);
			free(copy_cmd);
		} else {
			puts("Not backing up.");
		}
	}
	// apply the patches
	f = fopen(fn, "rb+");
	if (upx80 == 1)
		patch_exe(f, upx_80);
	if (mempatch == 1 && prompt("Apply memory patch? [y/n] ")) {
		fseek(f, 0x116, SEEK_SET);
		int c = fgetc(f);
		fseek(f, 0x116, SEEK_SET);
		fputc(c | 0x0020, f);
	}
	bool joy_patched = (joy80 == 2 || joy81_65 == 2 || joy81_141 == 2);
	if (joy80 == 1 && prompt("Apply GM8.0 joystick patch? [y/n] ")) {
		patch_exe(f, joypatch_80);
		joy_patched = true;
	}
	if (joy81_65 == 1 && prompt("Apply GM8.1.65 joystick patch? [y/n] ")) {
		patch_exe(f, joypatch_81_65);
		joy_patched = true;
	}
	if (joy81_141 == 1 && prompt("Apply GM8.1.141 joystick patch? [y/n] ")) {
		patch_exe(f, joypatch_81_141);
		joy_patched = true;
	}
	if (dplay80 == 1 && prompt("Apply GM8.0 DirectPlay patch? [y/n] "))
		patch_exe(f, dplaypatch_80);
	if (dplay81_65 == 1 && prompt("Apply GM8.1.65 DirectPlay patch? [y/n] "))
		patch_exe(f, dplaypatch_81_65);
	if (dplay81_141 == 1 && prompt("Apply GM8.1.141 DirectPlay patch? [y/n] "))
		patch_exe(f, dplaypatch_81_141);
	if ((sched80 == 1 || sched80upx == 1 || sched81_65 == 1 || sched81_141 == 1) && !joy_patched) {
		puts("It looks like the joystick patch wasn't applied. It's best to apply that if you're going to use the scheduler patch.");
	}
	if (sched80 == 1 && prompt("Apply GM8.0 scheduler patch? [y/n] "))
		patch_exe(f, schedpatch_80);
	if (sched80upx == 1 && prompt("Apply GM8.0 (UPX unpacked) scheduler patch? [y/n] "))
		patch_exe(f, schedpatch_80upx);
	if (sched81_65 == 1 && prompt("Apply GM8.1.65 scheduler patch? [y/n] "))
		patch_exe(f, schedpatch_81_65);
	if (sched81_141 == 1 && prompt("Apply GM8.1.141 scheduler patch? [y/n] "))
		patch_exe(f, schedpatch_81_141);
	fclose(f);
	puts("All done!");
	puts("Press Enter to close the patcher.");
	wait();
	return 0;
}

Patch upx_80[] = {
	{0x144ac1, 0xa4, 0xf0},
	{0x144ac2, 0x0a, 0x1c},
	{-1,0,0}
};

Patch joypatch_80[] = {
	{ 0x1399df, 0x53, 0xb8 },
	{ 0x1399e0, 0x6a, 0xa5 },
	{ 0x1399e2, 0xe8, 0x0 },
	{ 0x1399e3, 0x61, 0x0 },
	{ 0x1399e4, 0x7b, 0x90 },
	{ 0x1399e5, 0xf4, 0x90 },
	{ 0x1399e6, 0xff, 0x90 },
	{ 0x139ae0, 0x53, 0xb8 },
	{ 0x139ae1, 0x6a, 0xa5 },
	{ 0x139ae2, 0x1, 0x0 },
	{ 0x139ae3, 0xe8, 0x0 },
	{ 0x139ae4, 0x60, 0x0 },
	{ 0x139ae5, 0x7a, 0x90 },
	{ 0x139ae6, 0xf4, 0x90 },
	{ 0x139ae7, 0xff, 0x90 },
	{ 0x16466d, 0x50, 0xb8 },
	{ 0x16466e, 0x53, 0xa5 },
	{ 0x16466f, 0xe8, 0x0 },
	{ 0x164670, 0xcc, 0x0 },
	{ 0x164671, 0xce, 0x0 },
	{ 0x164672, 0xf1, 0x90 },
	{ 0x164673, 0xff, 0x90 },
	{ 0x1646cd, 0x50, 0xb8 },
	{ 0x1646ce, 0x56, 0xa5 },
	{ 0x1646cf, 0xe8, 0x0 },
	{ 0x1646d0, 0x6c, 0x0 },
	{ 0x1646d1, 0xce, 0x0 },
	{ 0x1646d2, 0xf1, 0x90 },
	{ 0x1646d3, 0xff, 0x90 },
	{ 0x164767, 0x68, 0xb8 },
	{ 0x164768, 0x94, 0xa5 },
	{ 0x164769, 0x1, 0x0 },
	{ 0x16476c, 0x8d, 0x90 },
	{ 0x16476d, 0x85, 0x90 },
	{ 0x16476e, 0x6c, 0x90 },
	{ 0x16476f, 0xfe, 0x90 },
	{ 0x164770, 0xff, 0x90 },
	{ 0x164771, 0xff, 0x90 },
	{ 0x164772, 0x50, 0x90 },
	{ 0x164773, 0x56, 0x90 },
	{ 0x164774, 0xe8, 0x90 },
	{ 0x164775, 0xbf, 0x90 },
	{ 0x164776, 0xcd, 0x90 },
	{ 0x164777, 0xf1, 0x90 },
	{ 0x164778, 0xff, 0x90 },
	{ 0x1647d1, 0x68, 0xb8 },
	{ 0x1647d2, 0x94, 0xa5 },
	{ 0x1647d3, 0x1, 0x0 },
	{ 0x1647d6, 0x8d, 0x90 },
	{ 0x1647d7, 0x85, 0x90 },
	{ 0x1647d8, 0x6c, 0x90 },
	{ 0x1647d9, 0xfe, 0x90 },
	{ 0x1647da, 0xff, 0x90 },
	{ 0x1647db, 0xff, 0x90 },
	{ 0x1647dc, 0x50, 0x90 },
	{ 0x1647dd, 0x56, 0x90 },
	{ 0x1647de, 0xe8, 0x90 },
	{ 0x1647df, 0x55, 0x90 },
	{ 0x1647e0, 0xcd, 0x90 },
	{ 0x1647e1, 0xf1, 0x90 },
	{ 0x1647e2, 0xff, 0x90 },
	{ 0x164849, 0x68, 0xb8 },
	{ 0x16484a, 0x94, 0xa5 },
	{ 0x16484b, 0x1, 0x0 },
	{ 0x16484e, 0x8d, 0x90 },
	{ 0x16484f, 0x85, 0x90 },
	{ 0x164850, 0x6c, 0x90 },
	{ 0x164851, 0xfe, 0x90 },
	{ 0x164852, 0xff, 0x90 },
	{ 0x164853, 0xff, 0x90 },
	{ 0x164854, 0x50, 0x90 },
	{ 0x164855, 0x56, 0x90 },
	{ 0x164856, 0xe8, 0x90 },
	{ 0x164857, 0xdd, 0x90 },
	{ 0x164858, 0xcc, 0x90 },
	{ 0x164859, 0xf1, 0x90 },
	{ 0x16485a, 0xff, 0x90 },
	{ 0x1648c1, 0x68, 0xb8 },
	{ 0x1648c2, 0x94, 0xa5 },
	{ 0x1648c3, 0x1, 0x0 },
	{ 0x1648c6, 0x8d, 0x90 },
	{ 0x1648c7, 0x85, 0x90 },
	{ 0x1648c8, 0x6c, 0x90 },
	{ 0x1648c9, 0xfe, 0x90 },
	{ 0x1648ca, 0xff, 0x90 },
	{ 0x1648cb, 0xff, 0x90 },
	{ 0x1648cc, 0x50, 0x90 },
	{ 0x1648cd, 0x56, 0x90 },
	{ 0x1648ce, 0xe8, 0x90 },
	{ 0x1648cf, 0x65, 0x90 },
	{ 0x1648d0, 0xcc, 0x90 },
	{ 0x1648d1, 0xf1, 0x90 },
	{ 0x1648d2, 0xff, 0x90 },
	{ 0x164948, 0x50, 0xb8 },
	{ 0x164949, 0x56, 0xa5 },
	{ 0x16494a, 0xe8, 0x0 },
	{ 0x16494b, 0xf9, 0x0 },
	{ 0x16494c, 0xcb, 0x0 },
	{ 0x16494d, 0xf1, 0x90 },
	{ 0x16494e, 0xff, 0x90 },
	{ 0x164daf, 0x50, 0xb8 },
	{ 0x164db0, 0x56, 0xa5 },
	{ 0x164db1, 0xe8, 0x0 },
	{ 0x164db2, 0x92, 0x0 },
	{ 0x164db3, 0xc7, 0x0 },
	{ 0x164db4, 0xf1, 0x90 },
	{ 0x164db5, 0xff, 0x90 },
	{ 0x164e2f, 0x50, 0xb8 },
	{ 0x164e30, 0x56, 0xa5 },
	{ 0x164e31, 0xe8, 0x0 },
	{ 0x164e32, 0x12, 0x0 },
	{ 0x164e33, 0xc7, 0x0 },
	{ 0x164e34, 0xf1, 0x90 },
	{ 0x164e35, 0xff, 0x90 },
	{ 0x164eaf, 0x50, 0xb8 },
	{ 0x164eb0, 0x56, 0xa5 },
	{ 0x164eb1, 0xe8, 0x0 },
	{ 0x164eb2, 0x92, 0x0 },
	{ 0x164eb3, 0xc6, 0x0 },
	{ 0x164eb4, 0xf1, 0x90 },
	{ 0x164eb5, 0xff, 0x90 },
	{ 0x164f2f, 0x50, 0xb8 },
	{ 0x164f30, 0x56, 0xa5 },
	{ 0x164f31, 0xe8, 0x0 },
	{ 0x164f32, 0x12, 0x0 },
	{ 0x164f33, 0xc6, 0x0 },
	{ 0x164f34, 0xf1, 0x90 },
	{ 0x164f35, 0xff, 0x90 },
	{ 0x164faf, 0x50, 0xb8 },
	{ 0x164fb0, 0x56, 0xa5 },
	{ 0x164fb1, 0xe8, 0x0 },
	{ 0x164fb2, 0x92, 0x0 },
	{ 0x164fb3, 0xc5, 0x0 },
	{ 0x164fb4, 0xf1, 0x90 },
	{ 0x164fb5, 0xff, 0x90 },
	{ 0x16502f, 0x50, 0xb8 },
	{ 0x165030, 0x56, 0xa5 },
	{ 0x165031, 0xe8, 0x0 },
	{ 0x165032, 0x12, 0x0 },
	{ 0x165033, 0xc5, 0x0 },
	{ 0x165034, 0xf1, 0x90 },
	{ 0x165035, 0xff, 0x90 },
	{ 0x1650b3, 0x50, 0xb8 },
	{ 0x1650b4, 0x56, 0xa5 },
	{ 0x1650b5, 0xe8, 0x0 },
	{ 0x1650b6, 0x8e, 0x0 },
	{ 0x1650b7, 0xc4, 0x0 },
	{ 0x1650b8, 0xf1, 0x90 },
	{ 0x1650b9, 0xff, 0x90 },
	{-1,0,0}
};

Patch joypatch_81_65[] = {
	{ 0x1cefb3, 0x53, 0xb8 },
	{ 0x1cefb4, 0x6a, 0xa5 },
	{ 0x1cefb6, 0xe8, 0x00 },
	{ 0x1cefb7, 0x4d, 0x00 },
	{ 0x1cefb8, 0xa2, 0x90 },
	{ 0x1cefb9, 0xf3, 0x90 },
	{ 0x1cefba, 0xff, 0x90 },
	{ 0x1cf0b4, 0x53, 0xb8 },
	{ 0x1cf0b5, 0x6a, 0xa5 },
	{ 0x1cf0b6, 0x01, 0x00 },
	{ 0x1cf0b7, 0xe8, 0x00 },
	{ 0x1cf0b8, 0x4c, 0x00 },
	{ 0x1cf0b9, 0xa1, 0x90 },
	{ 0x1cf0ba, 0xf3, 0x90 },
	{ 0x1cf0bb, 0xff, 0x90 },
	{ 0x20a5ea, 0x8d, 0xb8 },
	{ 0x20a5eb, 0x45, 0xa5 },
	{ 0x20a5ec, 0xf0, 0x00 },
	{ 0x20a5ed, 0x50, 0x00 },
	{ 0x20a5ee, 0x53, 0x00 },
	{ 0x20a5ef, 0xe8, 0x90 },
	{ 0x20a5f0, 0x0c, 0x90 },
	{ 0x20a5f1, 0xec, 0x90 },
	{ 0x20a5f2, 0xef, 0x90 },
	{ 0x20a5f3, 0xff, 0x90 },
	{ 0x20a64a, 0x8d, 0xb8 },
	{ 0x20a64b, 0x45, 0xa5 },
	{ 0x20a64c, 0xf0, 0x00 },
	{ 0x20a64d, 0x50, 0x00 },
	{ 0x20a64e, 0x56, 0x00 },
	{ 0x20a64f, 0xe8, 0x90 },
	{ 0x20a650, 0xac, 0x90 },
	{ 0x20a651, 0xeb, 0x90 },
	{ 0x20a652, 0xef, 0x90 },
	{ 0x20a653, 0xff, 0x90 },
	{ 0x20a6e9, 0x68, 0xb8 },
	{ 0x20a6ea, 0xd8, 0xa5 },
	{ 0x20a6eb, 0x02, 0x00 },
	{ 0x20a6ee, 0x8d, 0x90 },
	{ 0x20a6ef, 0x85, 0x90 },
	{ 0x20a6f0, 0x28, 0x90 },
	{ 0x20a6f1, 0xfd, 0x90 },
	{ 0x20a6f2, 0xff, 0x90 },
	{ 0x20a6f3, 0xff, 0x90 },
	{ 0x20a6f4, 0x50, 0x90 },
	{ 0x20a6f5, 0x56, 0x90 },
	{ 0x20a6f6, 0xe8, 0x90 },
	{ 0x20a6f7, 0xfd, 0x90 },
	{ 0x20a6f8, 0xea, 0x90 },
	{ 0x20a6f9, 0xef, 0x90 },
	{ 0x20a6fa, 0xff, 0x90 },
	{ 0x20a755, 0x68, 0xb8 },
	{ 0x20a756, 0xd8, 0xa5 },
	{ 0x20a757, 0x02, 0x00 },
	{ 0x20a75a, 0x8d, 0x90 },
	{ 0x20a75b, 0x85, 0x90 },
	{ 0x20a75c, 0x28, 0x90 },
	{ 0x20a75d, 0xfd, 0x90 },
	{ 0x20a75e, 0xff, 0x90 },
	{ 0x20a75f, 0xff, 0x90 },
	{ 0x20a760, 0x50, 0x90 },
	{ 0x20a761, 0x56, 0x90 },
	{ 0x20a762, 0xe8, 0x90 },
	{ 0x20a763, 0x91, 0x90 },
	{ 0x20a764, 0xea, 0x90 },
	{ 0x20a765, 0xef, 0x90 },
	{ 0x20a766, 0xff, 0x90 },
	{ 0x20a7cd, 0x68, 0xb8 },
	{ 0x20a7ce, 0xd8, 0xa5 },
	{ 0x20a7cf, 0x02, 0x00 },
	{ 0x20a7d2, 0x8d, 0x90 },
	{ 0x20a7d3, 0x85, 0x90 },
	{ 0x20a7d4, 0x28, 0x90 },
	{ 0x20a7d5, 0xfd, 0x90 },
	{ 0x20a7d6, 0xff, 0x90 },
	{ 0x20a7d7, 0xff, 0x90 },
	{ 0x20a7d8, 0x50, 0x90 },
	{ 0x20a7d9, 0x56, 0x90 },
	{ 0x20a7da, 0xe8, 0x90 },
	{ 0x20a7db, 0x19, 0x90 },
	{ 0x20a7dc, 0xea, 0x90 },
	{ 0x20a7dd, 0xef, 0x90 },
	{ 0x20a7de, 0xff, 0x90 },
	{ 0x20a845, 0x68, 0xb8 },
	{ 0x20a846, 0xd8, 0xa5 },
	{ 0x20a847, 0x02, 0x00 },
	{ 0x20a84a, 0x8d, 0x90 },
	{ 0x20a84b, 0x85, 0x90 },
	{ 0x20a84c, 0x28, 0x90 },
	{ 0x20a84d, 0xfd, 0x90 },
	{ 0x20a84e, 0xff, 0x90 },
	{ 0x20a84f, 0xff, 0x90 },
	{ 0x20a850, 0x50, 0x90 },
	{ 0x20a851, 0x56, 0x90 },
	{ 0x20a852, 0xe8, 0x90 },
	{ 0x20a853, 0xa1, 0x90 },
	{ 0x20a854, 0xe9, 0x90 },
	{ 0x20a855, 0xef, 0x90 },
	{ 0x20a856, 0xff, 0x90 },
	{ 0x20a8c9, 0x8d, 0xb8 },
	{ 0x20a8ca, 0x45, 0xa5 },
	{ 0x20a8cb, 0xcc, 0x00 },
	{ 0x20a8cc, 0x50, 0x00 },
	{ 0x20a8cd, 0x56, 0x00 },
	{ 0x20a8ce, 0xe8, 0x90 },
	{ 0x20a8cf, 0x35, 0x90 },
	{ 0x20a8d0, 0xe9, 0x90 },
	{ 0x20a8d1, 0xef, 0x90 },
	{ 0x20a8d2, 0xff, 0x90 },
	{ 0x20ad30, 0x8d, 0xb8 },
	{ 0x20ad31, 0x45, 0xa5 },
	{ 0x20ad32, 0xcc, 0x00 },
	{ 0x20ad33, 0x50, 0x00 },
	{ 0x20ad34, 0x56, 0x00 },
	{ 0x20ad35, 0xe8, 0x90 },
	{ 0x20ad36, 0xce, 0x90 },
	{ 0x20ad37, 0xe4, 0x90 },
	{ 0x20ad38, 0xef, 0x90 },
	{ 0x20ad39, 0xff, 0x90 },
	{ 0x20adb0, 0x8d, 0xb8 },
	{ 0x20adb1, 0x45, 0xa5 },
	{ 0x20adb2, 0xcc, 0x00 },
	{ 0x20adb3, 0x50, 0x00 },
	{ 0x20adb4, 0x56, 0x00 },
	{ 0x20adb5, 0xe8, 0x90 },
	{ 0x20adb6, 0x4e, 0x90 },
	{ 0x20adb7, 0xe4, 0x90 },
	{ 0x20adb8, 0xef, 0x90 },
	{ 0x20adb9, 0xff, 0x90 },
	{ 0x20ae30, 0x8d, 0xb8 },
	{ 0x20ae31, 0x45, 0xa5 },
	{ 0x20ae32, 0xcc, 0x00 },
	{ 0x20ae33, 0x50, 0x00 },
	{ 0x20ae34, 0x56, 0x00 },
	{ 0x20ae35, 0xe8, 0x90 },
	{ 0x20ae36, 0xce, 0x90 },
	{ 0x20ae37, 0xe3, 0x90 },
	{ 0x20ae38, 0xef, 0x90 },
	{ 0x20ae39, 0xff, 0x90 },
	{ 0x20aeb0, 0x8d, 0xb8 },
	{ 0x20aeb1, 0x45, 0xa5 },
	{ 0x20aeb2, 0xcc, 0x00 },
	{ 0x20aeb3, 0x50, 0x00 },
	{ 0x20aeb4, 0x56, 0x00 },
	{ 0x20aeb5, 0xe8, 0x90 },
	{ 0x20aeb6, 0x4e, 0x90 },
	{ 0x20aeb7, 0xe3, 0x90 },
	{ 0x20aeb8, 0xef, 0x90 },
	{ 0x20aeb9, 0xff, 0x90 },
	{ 0x20af30, 0x8d, 0xb8 },
	{ 0x20af31, 0x45, 0xa5 },
	{ 0x20af32, 0xcc, 0x00 },
	{ 0x20af33, 0x50, 0x00 },
	{ 0x20af34, 0x56, 0x00 },
	{ 0x20af35, 0xe8, 0x90 },
	{ 0x20af36, 0xce, 0x90 },
	{ 0x20af37, 0xe2, 0x90 },
	{ 0x20af38, 0xef, 0x90 },
	{ 0x20af39, 0xff, 0x90 },
	{ 0x20afb0, 0x8d, 0xb8 },
	{ 0x20afb1, 0x45, 0xa5 },
	{ 0x20afb2, 0xcc, 0x00 },
	{ 0x20afb3, 0x50, 0x00 },
	{ 0x20afb4, 0x56, 0x00 },
	{ 0x20afb5, 0xe8, 0x90 },
	{ 0x20afb6, 0x4e, 0x90 },
	{ 0x20afb7, 0xe2, 0x90 },
	{ 0x20afb8, 0xef, 0x90 },
	{ 0x20afb9, 0xff, 0x90 },
	{ 0x20b034, 0x8d, 0xb8 },
	{ 0x20b035, 0x45, 0xa5 },
	{ 0x20b036, 0xcc, 0x00 },
	{ 0x20b037, 0x50, 0x00 },
	{ 0x20b038, 0x56, 0x00 },
	{ 0x20b039, 0xe8, 0x90 },
	{ 0x20b03a, 0xca, 0x90 },
	{ 0x20b03b, 0xe1, 0x90 },
	{ 0x20b03c, 0xef, 0x90 },
	{ 0x20b03d, 0xff, 0x90 },
	{-1,0,0}
};

Patch joypatch_81_141[] = {
	{ 0x1f6ce7, 0x53, 0xb8 },
	{ 0x1f6ce8, 0x6a, 0xa5 },
	{ 0x1f6cea, 0xe8, 0x0 },
	{ 0x1f6ceb, 0x2d, 0x0 },
	{ 0x1f6cec, 0x59, 0x90 },
	{ 0x1f6ced, 0xf1, 0x90 },
	{ 0x1f6cee, 0xff, 0x90 },
	{ 0x1f6de8, 0x53, 0xb8 },
	{ 0x1f6de9, 0x6a, 0xa5 },
	{ 0x1f6dea, 0x1, 0x0 },
	{ 0x1f6deb, 0xe8, 0x0 },
	{ 0x1f6dec, 0x2c, 0x0 },
	{ 0x1f6ded, 0x58, 0x90 },
	{ 0x1f6dee, 0xf1, 0x90 },
	{ 0x1f6def, 0xff, 0x90 },
	{ 0x244711, 0x50, 0xb8 },
	{ 0x244712, 0x53, 0xa5 },
	{ 0x244713, 0xe8, 0x0 },
	{ 0x244714, 0xfc, 0x0 },
	{ 0x244715, 0x7e, 0x0 },
	{ 0x244716, 0xec, 0x90 },
	{ 0x244717, 0xff, 0x90 },
	{ 0x244771, 0x50, 0xb8 },
	{ 0x244772, 0x56, 0xa5 },
	{ 0x244773, 0xe8, 0x0 },
	{ 0x244774, 0x9c, 0x0 },
	{ 0x244775, 0x7e, 0x0 },
	{ 0x244776, 0xec, 0x90 },
	{ 0x244777, 0xff, 0x90 },
	{ 0x24480b, 0x68, 0xb8 },
	{ 0x24480c, 0xd8, 0xa5 },
	{ 0x24480d, 0x2, 0x0 },
	{ 0x244810, 0x8d, 0x90 },
	{ 0x244811, 0x85, 0x90 },
	{ 0x244812, 0x28, 0x90 },
	{ 0x244813, 0xfd, 0x90 },
	{ 0x244814, 0xff, 0x90 },
	{ 0x244815, 0xff, 0x90 },
	{ 0x244816, 0x50, 0x90 },
	{ 0x244817, 0x56, 0x90 },
	{ 0x244818, 0xe8, 0x90 },
	{ 0x244819, 0xef, 0x90 },
	{ 0x24481a, 0x7d, 0x90 },
	{ 0x24481b, 0xec, 0x90 },
	{ 0x24481c, 0xff, 0x90 },
	{ 0x24487d, 0x68, 0xb8 },
	{ 0x24487e, 0xd8, 0xa5 },
	{ 0x24487f, 0x2, 0x0 },
	{ 0x244882, 0x8d, 0x90 },
	{ 0x244883, 0x85, 0x90 },
	{ 0x244884, 0x28, 0x90 },
	{ 0x244885, 0xfd, 0x90 },
	{ 0x244886, 0xff, 0x90 },
	{ 0x244887, 0xff, 0x90 },
	{ 0x244888, 0x50, 0x90 },
	{ 0x244889, 0x56, 0x90 },
	{ 0x24488a, 0xe8, 0x90 },
	{ 0x24488b, 0x7d, 0x90 },
	{ 0x24488c, 0x7d, 0x90 },
	{ 0x24488d, 0xec, 0x90 },
	{ 0x24488e, 0xff, 0x90 },
	{ 0x2448f5, 0x68, 0xb8 },
	{ 0x2448f6, 0xd8, 0xa5 },
	{ 0x2448f7, 0x2, 0x0 },
	{ 0x2448fa, 0x8d, 0x90 },
	{ 0x2448fb, 0x85, 0x90 },
	{ 0x2448fc, 0x28, 0x90 },
	{ 0x2448fd, 0xfd, 0x90 },
	{ 0x2448fe, 0xff, 0x90 },
	{ 0x2448ff, 0xff, 0x90 },
	{ 0x244900, 0x50, 0x90 },
	{ 0x244901, 0x56, 0x90 },
	{ 0x244902, 0xe8, 0x90 },
	{ 0x244903, 0x5, 0x90 },
	{ 0x244904, 0x7d, 0x90 },
	{ 0x244905, 0xec, 0x90 },
	{ 0x244906, 0xff, 0x90 },
	{ 0x24496d, 0x68, 0xb8 },
	{ 0x24496e, 0xd8, 0xa5 },
	{ 0x24496f, 0x2, 0x0 },
	{ 0x244972, 0x8d, 0x90 },
	{ 0x244973, 0x85, 0x90 },
	{ 0x244974, 0x28, 0x90 },
	{ 0x244975, 0xfd, 0x90 },
	{ 0x244976, 0xff, 0x90 },
	{ 0x244977, 0xff, 0x90 },
	{ 0x244978, 0x50, 0x90 },
	{ 0x244979, 0x56, 0x90 },
	{ 0x24497a, 0xe8, 0x90 },
	{ 0x24497b, 0x8d, 0x90 },
	{ 0x24497c, 0x7c, 0x90 },
	{ 0x24497d, 0xec, 0x90 },
	{ 0x24497e, 0xff, 0x90 },
	{ 0x2449f4, 0x50, 0xb8 },
	{ 0x2449f5, 0x56, 0xa5 },
	{ 0x2449f6, 0xe8, 0x0 },
	{ 0x2449f7, 0x21, 0x0 },
	{ 0x2449f8, 0x7c, 0x0 },
	{ 0x2449f9, 0xec, 0x90 },
	{ 0x2449fa, 0xff, 0x90 },
	{ 0x244e5b, 0x50, 0xb8 },
	{ 0x244e5c, 0x56, 0xa5 },
	{ 0x244e5d, 0xe8, 0x0 },
	{ 0x244e5e, 0xba, 0x0 },
	{ 0x244e5f, 0x77, 0x0 },
	{ 0x244e60, 0xec, 0x90 },
	{ 0x244e61, 0xff, 0x90 },
	{ 0x244edb, 0x50, 0xb8 },
	{ 0x244edc, 0x56, 0xa5 },
	{ 0x244edd, 0xe8, 0x0 },
	{ 0x244ede, 0x3a, 0x0 },
	{ 0x244edf, 0x77, 0x0 },
	{ 0x244ee0, 0xec, 0x90 },
	{ 0x244ee1, 0xff, 0x90 },
	{ 0x244f5b, 0x50, 0xb8 },
	{ 0x244f5c, 0x56, 0xa5 },
	{ 0x244f5d, 0xe8, 0x0 },
	{ 0x244f5e, 0xba, 0x0 },
	{ 0x244f5f, 0x76, 0x0 },
	{ 0x244f60, 0xec, 0x90 },
	{ 0x244f61, 0xff, 0x90 },
	{ 0x244fdb, 0x50, 0xb8 },
	{ 0x244fdc, 0x56, 0xa5 },
	{ 0x244fdd, 0xe8, 0x0 },
	{ 0x244fde, 0x3a, 0x0 },
	{ 0x244fdf, 0x76, 0x0 },
	{ 0x244fe0, 0xec, 0x90 },
	{ 0x244fe1, 0xff, 0x90 },
	{ 0x24505b, 0x50, 0xb8 },
	{ 0x24505c, 0x56, 0xa5 },
	{ 0x24505d, 0xe8, 0x0 },
	{ 0x24505e, 0xba, 0x0 },
	{ 0x24505f, 0x75, 0x0 },
	{ 0x245060, 0xec, 0x90 },
	{ 0x245061, 0xff, 0x90 },
	{ 0x2450db, 0x50, 0xb8 },
	{ 0x2450dc, 0x56, 0xa5 },
	{ 0x2450dd, 0xe8, 0x0 },
	{ 0x2450de, 0x3a, 0x0 },
	{ 0x2450df, 0x75, 0x0 },
	{ 0x2450e0, 0xec, 0x90 },
	{ 0x2450e1, 0xff, 0x90 },
	{ 0x24515f, 0x50, 0xb8 },
	{ 0x245160, 0x56, 0xa5 },
	{ 0x245161, 0xe8, 0x0 },
	{ 0x245162, 0xb6, 0x0 },
	{ 0x245163, 0x74, 0x0 },
	{ 0x245164, 0xec, 0x90 },
	{ 0x245165, 0xff, 0x90 },
	{-1,0,0}
};

Patch dplaypatch_80[] = {
	{ 0x187380, 'D', 0 },
	{-1,0,0}
};

Patch dplaypatch_81_65[] = {
	{ 0x23d184, 'D', 0 },
	{-1,0,0}
};

Patch dplaypatch_81_141[] = {
	{ 0x279c10, 'D', 0 },
	{-1,0,0}
};

Patch schedpatch_80[] = {
	{0x14461a, 0xb8, 0x6a},
	{0x14461b, 0x2d, 0x01},
	{0x14461c, 0x00, 0xe8},
	{0x14461d, 0x00, 0x17},
	{0x14461e, 0x00, 0xcf},
	{0x14461f, 0xe8, 0xf3},
	{0x144620, 0x18, 0xff},
	{0x144621, 0xef, 0x90},
	{0x144622, 0xff, 0x90},
	{0x144623, 0xff, 0x90},
	{0x191e82, 0x6a, 0x74},
	{0x191e83, 0x6f, 0x69},
	{0x191e84, 0x79, 0x6d},
	{0x191e85, 0x47, 0x65},
	{0x191e86, 0x65, 0x42},
	{0x191e87, 0x74, 0x65},
	{0x191e88, 0x44, 0x67},
	{0x191e89, 0x65, 0x69},
	{0x191e8a, 0x76, 0x6e},
	{0x191e8b, 0x43, 0x50},
	{0x191e8c, 0x61, 0x65},
	{0x191e8d, 0x70, 0x72},
	{0x191e8e, 0x73, 0x69},
	{0x191e8f, 0x41, 0x6f},
	{0x191e90, 0x00, 0x64},
	{-1,0,0}
};

Patch schedpatch_80upx[] = {
	{0x14461a, 0xb8, 0x6a},
	{0x14461b, 0x2d, 0x01},
	{0x14461c, 0x00, 0xe8},
	{0x14461d, 0x00, 0x17},
	{0x14461e, 0x00, 0xcf},
	{0x14461f, 0xe8, 0xf3},
	{0x144620, 0x18, 0xff},
	{0x144621, 0xef, 0x90},
	{0x144622, 0xff, 0x90},
	{0x144623, 0xff, 0x90},
	{0x191c4e, 0x6a, 0x74},
	{0x191c4f, 0x6f, 0x69},
	{0x191c50, 0x79, 0x6d},
	{0x191c51, 0x47, 0x65},
	{0x191c52, 0x65, 0x42},
	{0x191c53, 0x74, 0x65},
	{0x191c54, 0x44, 0x67},
	{0x191c55, 0x65, 0x69},
	{0x191c56, 0x76, 0x6e},
	{0x191c57, 0x43, 0x50},
	{0x191c58, 0x61, 0x65},
	{0x191c59, 0x70, 0x72},
	{0x191c5a, 0x73, 0x69},
	{0x191c5b, 0x41, 0x6f},
	{0x191c5c, 0x00, 0x64},
	{-1,0,0}
};

Patch schedpatch_81_65[] = {
	{ 0x1e3fd6, 0xb8, 0x6a },
	{ 0x1e3fd7, 0x2d, 0x01 },
	{ 0x1e3fd8, 0x00, 0xe8 },
	{ 0x1e3fd9, 0x00, 0x1b },
	{ 0x1e3fda, 0x00, 0x52 },
	{ 0x1e3fdb, 0xe8, 0xf2 },
	{ 0x1e3fdc, 0x98, 0xff },
	{ 0x1e3fdd, 0xe7, 0x90 },
	{ 0x1e3fde, 0xff, 0x90 },
	{ 0x1e3fdf, 0xff, 0x90 },
	{ 0x24cb5e, 0x6a, 0x74 },
	{ 0x24cb5f, 0x6f, 0x69 },
	{ 0x24cb60, 0x79, 0x6d },
	{ 0x24cb61, 0x47, 0x65 },
	{ 0x24cb62, 0x65, 0x42 },
	{ 0x24cb63, 0x74, 0x65 },
	{ 0x24cb64, 0x44, 0x67 },
	{ 0x24cb65, 0x65, 0x69 },
	{ 0x24cb66, 0x76, 0x6e },
	{ 0x24cb67, 0x43, 0x50 },
	{ 0x24cb68, 0x61, 0x65 },
	{ 0x24cb69, 0x70, 0x72 },
	{ 0x24cb6a, 0x73, 0x69 },
	{ 0x24cb6b, 0x57, 0x6f },
	{ 0x24cb6c, 0x00, 0x64 },
		{-1,0,0}
};

Patch schedpatch_81_141[] = {
	{0x279f23, 0xb8, 0x6a},
	{0x279f24, 0x20, 0x01},
	{0x279f25, 0xb1, 0xe8},
	{0x279f26, 0x67, 0xe2},
	{0x279f27, 0x00, 0x22},
	{0x279f28, 0xe8, 0xe9},
	{0x279f29, 0xd7, 0xff},
	{0x279f2a, 0x67, 0x90},
	{0x279f2b, 0xee, 0x90},
	{0x279f2c, 0xff, 0x90},
	{0x28be88, 0x6a, 0x74},
	{0x28be89, 0x6f, 0x69},
	{0x28be8a, 0x79, 0x6d},
	{0x28be8b, 0x47, 0x65},
	{0x28be8c, 0x65, 0x42},
	{0x28be8d, 0x74, 0x65},
	{0x28be8e, 0x44, 0x67},
	{0x28be8f, 0x65, 0x69},
	{0x28be90, 0x76, 0x6e},
	{0x28be91, 0x43, 0x50},
	{0x28be92, 0x61, 0x65},
	{0x28be93, 0x70, 0x72},
	{0x28be94, 0x73, 0x69},
	{0x28be95, 0x57, 0x6f},
	{0x28be96, 0x00, 0x64},
	{-1,0,0}
};
